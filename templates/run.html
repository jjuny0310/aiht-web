<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>AIHT - Run</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="../static/main/img/favicon.png" rel="icon">
  <link href="../static/main/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Montserrat:300,400,500,600,700" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../static/main/vendor/aos/aos.css" rel="stylesheet">
  <link href="../static/main/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../static/main/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../static/main/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="../static/main/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="../static/main/css/style.css" rel="stylesheet">

  <!-- Modal CSS File -->
  <link href="../static/main/css/modal.css" rel="stylesheet">

  <!-- MediaPipe JS Files -->
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/control_utils_3d.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

  <!-- WebSocket JS Files -->
  <script type="text/javascript" src="//cdn.socket.io/4.4.1/socket.io.min.js"></script>

  <!-- Core(동영상 배치) -->
  <link rel="stylesheet" href="../static/main/core/styles.css">
  <script src="../static/main/core/script.js"></script>
</head>

<body>
  <!-- ======= Header ======= -->
  <header id="run_header" class="fixed-top d-flex align-items-center header-transparent">
    <div class="container d-flex align-items-center">

      <h1 class="logo me-auto"><a href="/">AIHT</a></h1>
      <!-- Uncomment below if you prefer to use an image logo -->
      <!-- <a href="index.html" class="logo me-auto"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->

      <nav id="navbar" class="navbar order-last order-lg-0">
        <ul>
          <li><a class="nav-link scrollto" href="/">메인</a></li>
          <li><a class="nav-link scrollto" href="/#services">서비스</a></li>
            {% if session['login'] %}
                <li><a class="nav-link scrollto" href="/result_list">운동 내역</a></li>
                <li class="dropdown"><a href="#"><span>내 정보</span> <i class="bi bi-chevron-down"></i></a>
                <ul>
                    <li><a href="#"><strong>{{ session['nickname'] }}님 환영합니다.</strong></a></li>
                </ul>
              </li>
              <li><a class="nav-link scrollto" href="/logout">로그아웃</a></li>
            {% else %}
            <li><a class="nav-link scrollto" href="/login">로그인</a></li>
            {% endif %}
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

      <div class="social-links">
        <a href="https://github.com/jjuny0310" class="github"><i class="bi bi-github"></i></a>
        <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
        <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
      </div>

    </div>
  </header><!-- End Header -->

  <!-- ======= Run Section ======= -->

    <!--Loading -->
    <div id='loadingImg'>
        <img id="loading" src='../static/loading/gif/loading.gif'/>
    </div><!-- End Loading -->

  <section id="run" class="clearfix">
      <div id="Dish">
          <!-- Trainer Video -->
          <div id="trainer" class="Camera">
              <!-- SQUAT -->
              {% if exercise_type == "SQUAT" %}
                  {% if goal_number == 10 %}
                      <video id="trainer_video" src="../static/video/squat_10.mp4" muted onended="endVideo()"></video>
                  {% elif goal_number == 20 %}
                      <video id="trainer_video" src="../static/video/squat_20.mp4" muted onended="endVideo()"></video>
                  {% elif goal_number == 30 %}
                      <video id="trainer_video" src="../static/video/squat_30.mp4" muted onended="endVideo()"></video>
                  {% endif %}
              <!-- PUSH_UP -->
              {% elif exercise_type == "PUSH_UP" %}
                  {% if goal_number == 10 %}
                      <video id="trainer_video" src="../static/video/pushup_10.mp4" muted onended="endVideo()"></video>
                  {% elif goal_number == 20 %}
                      <video id="trainer_video" src="../static/video/pushup_20.mp4" muted onended="endVideo()"></video>
                  {% elif goal_number == 30 %}
                      <video id="trainer_video" src="../static/video/pushup_30.mp4" muted onended="endVideo()"></video>
                  {% endif %}
              {% endif %}
          </div>

          <!-- WebCam -->
          <div id="webcam" class="Camera">
              <video id="input_video" class="input_video"></video>
              <canvas id="output_canvas" class="output_canvas" width="480px" height="480px"></canvas>

              <div id="webcam_bar">
                  <div id="count_text">
                    <b id="text" style="font-size: 1.5em"><strong id="count">현재 횟수 : 0</strong> / <strong>{{ goal_number }}</strong></b>
                      <div id="btn_group">
                          <!--<button id="fullscreen_btn">전체화면</button>-->
                          <button id="stop_btn" onclick="stop()">종료</button>
                      </div>
                  </div>
              </div>

          </div>
      </div>

  </section><!-- End Run -->

  <main id="main">
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="../static/main/vendor/aos/aos.js"></script>
  <script src="../static/main/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../static/main/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../static/main/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="../static/main/js/main.js"></script>

  <!-- Main JS Files -->
  <script src="../static/main/js/loading.js"></script>
  <!-- <script src="../static/main/js/human_pose.js"></script> -->
  <script src="../static/main/js/fullscreen.js"></script>

  </main>

<!-- Human Pose(WebSocket) -->
<script type="text/javascript">
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');

    var count = 0;
    var countText = document.getElementById('count_text');
    var webcamBar = document.getElementById('webcam_bar');
    var correct_pose = true;
    var soundDelay = 4000;
    var readyTime = 10000;

    LoadingWithMask();
    // 웹소켓
    var webSocketFlag = true;
    var socket;

    // 플래그 변수
    var loadingFlag = true;
    var readyFlag = false;
    var poseSoundFlag = true;
    var trainerEndFlag = true;
    var downSoundFlag = true;
    var exerciseEndFlag = true;
    var runStop = false;

    // 1. 스쿼트 자세교정 오디오 변수
    var ankleNarrowSound = new Audio('../static/sound/squat/ankle_narrow.wav');
    var ankleWideSound = new Audio('../static/sound/squat/ankle_wide.wav');
    var footNarrowSound = new Audio('../static/sound/squat/foot_narrow.wav');
    var footWideSound = new Audio('../static/sound/squat/foot_wide.wav');
    var squatNothingSound = new Audio('../static/sound/squat/nothing.wav');

    // 2. 푸쉬업 자세교정 오디오 변수
    var hipSound = new Audio('../static/sound/push_up/hip.wav');
    var handSound = new Audio('../static/sound/push_up/hand.wav');
    var pushupNothingSound = new Audio('../static/sound/push_up/nothing.wav');

    // 3. 시작 오디오 변수
    var startSound = new Audio('../static/sound/start/exercise_start.wav');
    var readySound = new Audio('../static/sound/start/ready.wav');

    // 4. 종료 오디오 변수
    var trainerEndSound = new Audio('../static/sound/end/trainer_end.wav');
    var exerciseEndSound = new Audio('../static/sound/end/exercise_end.wav');

    // 5. 카운트 오디오 변수
    var downSound = new Audio('../static/sound/count/down.wav');

    // 6. 로딩 오디오 변수
    var loadingSound = new Audio('../static/loading/sound/loading_sound.wav');
    loadingSound.play();

    // 결과 페이지 변수
    var now = new Date();
    var monthDate = (now.getMonth()+1) + "월 " + now.getDate() + "일";
    var startTime = 0;
    var endTime = 0;
    var exerciseType = "";

    // 종료 버튼 클릭 시 처리
    function stop(){
        if(readyFlag === false){
            alert("아직 종료할 수 없습니다.");
        }
        else if(count <= 0){
            alert("운동 횟수가 1회 이상일 때만 종료가 가능합니다.")
        }
        else if(exerciseEndFlag)
        {
            answer = confirm("운동을 종료할까요?");
            if (answer) {
                runStop = true;
            }
        }
    }

    // 모든 사운드 중지
    function allSoundStop(){
        ankleNarrowSound.pause();
        ankleWideSound.pause();
        footNarrowSound.pause();
        footWideSound.pause();
        squatNothingSound.pause();

        hipSound.pause();
        handSound.pause();
        pushupNothingSound.pause();

        startSound.pause();
        readySound.pause();

        trainerEndSound.pause();
        exerciseEndSound.pause();

        downSound.pause();

        ankleNarrowSound.currentTime = 0;
        ankleWideSound.currentTime = 0;
        footNarrowSound.currentTime = 0;
        footWideSound.currentTime = 0;
        squatNothingSound.currentTime = 0;

        hipSound.currentTime = 0;
        handSound.currentTime = 0;
        pushupNothingSound.currentTime = 0;

        startSound.currentTime = 0;
        readySound.currentTime = 0;

        trainerEndSound.currentTime = 0;
        exerciseEndSound.currentTime = 0;

        downSound.currentTime = 0;
    }

    // 트레이너 비디오 종료 시 처리
    function endVideo(){
        trainerEndFlag = false;
        ankleNarrowSound.pause();
        ankleWideSound.pause();
        footNarrowSound.pause();
        footWideSound.pause();
        squatNothingSound.pause();

        hipSound.pause();
        handSound.pause();
        pushupNothingSound.pause();

        trainerEndSound.play();

        ankleNarrowSound.currentTime = 0;
        ankleWideSound.currentTime = 0;
        footNarrowSound.currentTime = 0;
        footWideSound.currentTime = 0;
        squatNothingSound.currentTime = 0;

        hipSound.currentTime = 0;
        handSound.currentTime = 0;
        pushupNothingSound.currentTime = 0;

        trainerEndSound.play();
        setTimeout(function() { trainerEndFlag = true;}, 6000);
    }
    function poseOnResults(results) {
        // 캔버스 조정
        canvasElement.style.position = "absolute";
        canvasElement.style.left = "0";
        canvasElement.style.top = "0";
        canvasElement.style.width = "100%";
        canvasElement.style.height = "100%";
        canvasElement.style.objectFit = "contain";
        canvasElement.style.transform = "rotateY(180deg)";

        // 관절선
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if(correct_pose){
             drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                     {color: '#ffffff', lineWidth: 2});
        }
        else{
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                     {color: '#ff0000', lineWidth: 2});

        }
        drawLandmarks(canvasCtx, results.poseLandmarks,
                    {color: '#BDBDBD', lineWidth: 1});

        var dataList = {
            'pose_landmarks' : results.poseLandmarks,
            'ready_flag' : readyFlag,
        }
        // 웹소켓
        if(webSocketFlag){
            webSocketFlag = false
            socket = io.connect('https://' + document.domain + ':' + location.port + '/run')

            socket.on('connect', function (){
                console.log("웹소켓 연결 성공!")
                socket.emit('joined', {});
            });
        }

        // 관절 좌표 전달
        socket.emit('run', {'data':dataList});

        socket.on('run', function (result){
            // 머신러닝 처리 결과 받아서 작업수행
            console.log(result.data);
        });

        //##################################################AJAX시작######################################
        // 해당 url로 json 데이터 전달(ajax 통신)
        $.ajax({
            type: 'POST',
            url: '/exercise_analysis',
            data: JSON.stringify(dataList),
            dataType : 'JSON',
            contentType: "application/json",
            async: false,
            success: function (data){
                // 로딩 완료 시 초기세팅
                if(loadingFlag) {
                    closeLoadingWithMask();
                    loadingSound.pause();
                    loadingSound.currentTime = 0;
                    loadingFlag = false;
                    webcamBar.style.display = "block";

                    // 대기시간
                    readySound.play();
                    setTimeout(function() {
                        startSound.play();

                        setTimeout(function() {
                        startTime = new Date().getTime() / 1000;
                        $('#trainer_video').get(0).play();
                        readyFlag = true;}, 1000);
                        }, readyTime);
                }
                // 종료 시
                if((data.goal_number === count && exerciseEndFlag) || runStop){
                    allSoundStop();
                    exerciseEndFlag = false;
                    runStop = false;

                    endTime = new Date().getTime() / 1000;
                    var exerciseTime = parseInt(endTime-startTime);
                    exerciseTime = parseInt(exerciseTime / 60) + "분 " + (exerciseTime % 60) + "초";

                    setTimeout(function() { exerciseEndSound.play(); }, 500);
                    setTimeout(function() {
                        location.href = "/result?date=" + monthDate + "&exercise="+exerciseType + "&result_num=" + (count+" / "+data.goal_number)
                                        + "&exercise_time=" + exerciseTime; }, 5000);
                }

                switch (data.exercise_type){
                    case "SQUAT":
                        // python 에서 전달받은 값
                        correct_pose = data.correct_pose;
                        exerciseType = "스쿼트"

                        // 사용자가 지정한 횟수까지 수행
                        if(readyFlag && count < data.goal_number){
                             // 카운트 및 각도 체크 사운드
                            if(downSoundFlag && data.angle_check){
                                downSound.play();
                                downSoundFlag = false;
                            }
                            if(count !== data.count){
                                count = data.count
                                new Audio('../static/sound/count/' + count + '.wav').play();
                                document.getElementById('count').innerHTML = "현재 횟수 : " + count;
                                downSoundFlag = true;
                            }

                            // 자세교정 안내 음성
                            if(poseSoundFlag && trainerEndFlag && data.state==="UP" && data.visibility){
                                if(data.correct_dict['ankle_state'] === "narrow"){
                                    ankleWideSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay);
                                }
                                else if(data.correct_dict['ankle_state'] === "wide"){
                                    ankleNarrowSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay);
                                }
                                else if(data.correct_dict['foot_state'] === "narrow"){
                                    footWideSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay+2000);
                                }
                                else if(data.correct_dict['foot_state'] === "wide"){
                                    footNarrowSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay+2000);
                                }
                            }
                            else if(poseSoundFlag && trainerEndFlag && data.state==="NOTHING" && data.visibility){
                                    squatNothingSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay);
                            }
                        }
                        break;
                    case "PUSH_UP":
                        // python 에서 전달받은 값
                        correct_pose = data.correct_pose;
                        exerciseType = "푸쉬업"

                        // 사용자가 지정한 횟수까지 수행
                        if(readyFlag && count < data.goal_number) {
                            // 카운트 및 각도 체크 사운드
                            if (downSoundFlag && data.angle_check) {
                                downSound.play();
                                downSoundFlag = false;
                            }
                            if (count !== data.count) {
                                count = data.count
                                new Audio('../static/sound/count/' + count + '.wav').play();
                                document.getElementById('count').innerHTML = "현재 횟수 : " + count;
                                downSoundFlag = true;
                            }
                            // 자세교정 안내 음성
                            if(poseSoundFlag && trainerEndFlag && data.state==="UP" && data.visibility){
                                if(!data.correct_dict['correct_hand']){
                                    handSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay);
                                }
                                else if(!data.correct_dict['correct_hip']){
                                    hipSound.play();
                                    poseSoundFlag = false;
                                    setTimeout(function() { poseSoundFlag = true;}, soundDelay);
                                }
                            }
                            else if(poseSoundFlag && trainerEndFlag && data.state==="NOTHING" && data.visibility){
                                pushupNothingSound.play();
                                poseSoundFlag = false;
                                setTimeout(function() { poseSoundFlag = true;}, soundDelay);
                            }
                        }
                        break;
                }
            },
            error: function (request, status, error){
            }
        })
        //##################################################AJAX 끝######################################
      canvasCtx.restore();
    }

    const pose = new Pose({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }});
    pose.setOptions({
      modelComplexity: 1,
      selfieMode: false,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    pose.onResults(poseOnResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await pose.send({image: videoElement});
      },
      width: 480,
      height: 480
    });
    camera.start();
</script>
</body>
</html>